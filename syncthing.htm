<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Syncthing - wiki1.mikf.pl</title>
  </head>
  <body>
    <h1>Syncthing</h1>
    <h2>system service with own user</h2>
    <h3>a watcher that makes everything be owned by
      _syncthing:_syncthing</h3>
    <p>Get <a moz-do-not-send="true"
        href="https://emcrisostomo.github.io/fswatch/">https://emcrisostomo.github.io/fswatch/</a><br>
      <br>
    </p>
    <h3>a script that makes everything be owned by _syncthing:_syncthing
      periodically (too slow)<br>
    </h3>
    <p>*/3 * * * * _syncthing -ns /etc/the_syncthing_script.sh<br>
    </p>
    <blockquote>#!/bin/sh<br>
      PREOWN='chown '<br>
      FINALOWN='chown 1000 {}'<br>
      case `id -u` in<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | `id -u _syncthing`)<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      ;;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1000)<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      PREOWN="doas chown 1000"<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      FINALOWN=true<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      ;;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *)<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &gt;&amp;2 echo "bad user $(whoami)"<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      exit 1<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      ;;<br>
      esac<br>
      <br>
      # find everything in Biezace owned by _syncthing<br>
      # chown to group syncthing<br>
      # chown to us if needed for chmod<br>
      # chmod g+w<br>
      # if directory, chmod ug+x<br>
      # chown to user if not already<br>
      # stderr all failures<br>
      <br>
      ECHO="-exec echo"<br>
      <br>
      find /var/syncthing/Biezace \<br>
      -user _syncthing \<br>
      \( \<br>
      -exec ${PREOWN}:_syncthing {} \; -o \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ECHO 1 {} \; \) \<br>
      \( \<br>
      -exec chmod g+w {} \; -o \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ECHO 2 {} \; \) \<br>
      \( \(&nbsp;&nbsp; \(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -type d \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      -exec chmod ug+x {} \; -o \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      $ECHO 3 {} \; \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \) \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -or \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -exec true \; \<br>
      \) -o \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ECHO 4 {} \; \) \<br>
      \( \<br>
      -exec $FINALOWN \; -o \<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ECHO 5 {} \; \) \<br>
      | ifne -n false&nbsp; # moreutils; so cron -n sends fail email<br>
      <br>
    </blockquote>
  </body>
</html>
